<!DOCTYPE html>
<html>
  <head>
    <script>
      window.RudderSnippetVersion = '3.0.1';
      var sdkBaseUrl = 'https://cdn.rudderlabs.com/v3';
      var sdkName = 'rsa.min.js';
      var asyncScript = true;
      window.rudderAnalyticsBuildType = 'legacy';
      window.rudderanalytics = [];
      var methods = [
        'setDefaultInstanceKey',
        'load',
        'ready',
        'page',
        'track',
        'identify',
        'alias',
        'group',
        'reset',
        'setAnonymousId',
        'startSession',
        'endSession',
        'consent'
      ];
      for (var i = 0; i < methods.length; i++) {
        var method = methods[i];
        window.rudderanalytics[method] = (function (methodName) {
          return function () {
            window.rudderanalytics.push([methodName].concat(Array.prototype.slice.call(arguments)));
          };
        })(method);
      }
      try {
        new Function('return import("")');
        window.rudderAnalyticsBuildType = 'modern';
      } catch (e) {}
      window.rudderAnalyticsMount = function () {
        if (typeof globalThis === 'undefined') {
          Object.defineProperty(Object.prototype, '__globalThis_magic__', {
            get: function get() {
              return this;
            },
            configurable: true
          });
          __globalThis_magic__.globalThis = __globalThis_magic__;
          delete Object.prototype.__globalThis_magic__;
        }
        var rudderAnalyticsScript = document.createElement('script');
        rudderAnalyticsScript.src = ''
          .concat(sdkBaseUrl, '/')
          .concat(window.rudderAnalyticsBuildType, '/')
          .concat(sdkName);
        rudderAnalyticsScript.async = asyncScript;
        // Commented out as the local build file is auto-injected by rollup
        // if (document.head) {
        //   document.head.appendChild(rudderAnalyticsScript);
        // } else {
        //   document.body.appendChild(rudderAnalyticsScript);
        // }
      };
      if (typeof Promise === 'undefined' || typeof globalThis === 'undefined') {
        var rudderAnalyticsPromisesScript = document.createElement('script');
        rudderAnalyticsPromisesScript.src =
          'https://polyfill-fastly.io/v3/polyfill.min.js?version=3.111.0&features=Symbol%2CPromise&callback=rudderAnalyticsMount';
        rudderAnalyticsPromisesScript.async = asyncScript;
        if (document.head) {
          document.head.appendChild(rudderAnalyticsPromisesScript);
        } else {
          document.body.appendChild(rudderAnalyticsPromisesScript);
        }
      } else {
        window.rudderAnalyticsMount();
      }
      // New addition to load script ends

      var loadOptions = {
        logLevel: 'DEBUG',
        configUrl: '__CONFIG_SERVER_HOST__',
        destSDKBaseURL:
          '__DEST_SDK_BASE_URL__' + window.rudderAnalyticsBuildType + '/js-integrations',
        pluginsSDKBaseURL: '__PLUGINS_BASE_URL__' + window.rudderAnalyticsBuildType + '/plugins',
        // useServerSideCookies:true,
        // queueOptions: {
        //   batch: {
        //     maxSize: 5 * 1024, // 5KB
        //   },
        // },
        // useBeacon: true,
        // beaconQueueOptions: {
        //   flushQueueInterval: 10 * 1000,
        //   maxItems: 5,
        // },
        // sessions: {
        //   autoTrack: true,
        //   timeout: 30 * 1000
        // },
        storage: {
          encryption: {
            version: 'v3'
          },
          migrate: true,
          // cookie: {
          //   expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
          //   path: '/',
          //   samesite: 'Lax',
          //   secure: true,
          // },
          // type: 'localStorage',
          // entries: {
          //   userId: {
          //     type: 'cookieStorage',
          //   },
          //   userTraits: {
          //     type: 'localStorage',
          //   },
          //   groupId: {
          //     type: 'none',
          //   },
          //   anonymousId: {
          //     type: 'cookieStorage',
          //   },
          // },
        // },
        // consentManagement: {
        //   enabled: true,
        //   provider: "custom",
        // },
        // preConsent: {
        //   enabled: true,
        //   storage: {
        //     strategy: 'session'
        //   },
        //   events: {
        //     delivery: 'buffer'
        //   }
        }
        // plugins: [
        //   'StorageEncryption',
        //   'StorageMigrator',
        //   'XhrQueue'
        // ]
      };

      rudderanalytics.load('__WRITE_KEY__', '__DATAPLANE_URL__', loadOptions);

      rudderanalytics.identify(
        'customUserID',
        {
          name: 'John Doe',
          title: 'CEO',
          email: 'name.surname@domain.com',
          company: 'Company123',
          phone: '123-456-7890',
          rating: 'Hot',
          city: 'Austin',
          postalCode: '12345',
          country: 'US',
          street: 'Sample Address',
          state: 'TX',
        },
        function (message) {
          console.log('in identify call', message);
        }
      );

      rudderanalytics.page(
        'Home',
        'Cart Viewed',
        {
          path: '',
          referrer: '',
          search: '',
          title: '',
          url: '',
        },
        function (message) {
          console.log('in page call', message);
        }
      );

      rudderanalytics.track(
        'test track event 1',
        {
          revenue: 30,
          currency: 'USD',
          user_actual_id: 12345,
        },
        function (message) {
          console.log('in track call 1', message);
        }
      );

      rudderanalytics.track(
        'test track event 2',
        {
          revenue: 45,
          currency: 'INR',
          user_actual_id: 333,
        },
        function (message) {
          console.log('in track call 2', message);
        }
      );

      rudderanalytics.track(
        'test track event 3',
        {
          revenue: 10003,
          currency: 'EUR',
          user_actual_id: 5678,
        },
        function (message) {
          console.log('in track call 3', message);
        }
      );

      rudderanalytics.ready(function () {
        console.log('All ready!!!');
      });

      document.addEventListener('RSA_Initialised', function (e) {
        console.log('RSA_Initialised', e.detail.analyticsInstance);
      });

      document.addEventListener('RSA_Ready', function (e) {
        console.log('RSA_Ready', e.detail.analyticsInstance);
      });
    </script>
  </head>
  <body>
    <h1>Test HTML file</h1>
    <br />

    <button data-testid="page-btn" onclick="page()">Page</button>
    <button data-testid="identify-btn" onclick="identify()">identify</button>
    <button data-testid="track-btn" onclick="track()">Track</button>
    <button data-testid="alias-btn" onclick="alias()">Alias</button>
    <button data-testid="group-btn" onclick="group()">Group</button>

    <p data-testid="action" id="action"></p>
    <p data-testid="payload" id="rudderElement"></p>

    <script>
      function page() {
        rudderanalytics.page(
          'Home',
          'Cart Viewed',
          {
            path: '',
            referrer: '',
            search: '',
            title: '',
            url: '',
          },
          function (rudderElement) {
            console.log('in page call');
            document.getElementById('action').innerHTML = 'Page called';
            document.getElementById('rudderElement').innerHTML = JSON.stringify(rudderElement);
          }
        );
      }

      function identify() {
        rudderanalytics.identify(
          'customUserID',
          {
            name: 'John Doe',
            title: 'CEO',
            email: 'name.surname@domain.com',
            company: 'Company123',
            phone: '123-456-7890',
            rating: 'Hot',
            city: 'Austin',
            postalCode: '12345',
            country: 'US',
            street: 'Sample Address',
            state: 'TX',
          },
          {},
          function (rudderElement) {
            console.log('in identify call');
            document.getElementById('action').innerHTML = 'Identify called';
            document.getElementById('rudderElement').innerHTML = JSON.stringify(rudderElement);
          }
        );
      }

      function track() {
        rudderanalytics.track(
          'test track event 1',
          {
            revenue: 30,
            currency: 'USD',
            user_actual_id: 12345,
          },
          function (rudderElement) {
            console.log('in track call');
            document.getElementById('action').innerHTML = 'Track called';
            document.getElementById('rudderElement').innerHTML = JSON.stringify(rudderElement);
          }
        );
      }

      function alias() {
        rudderanalytics.alias('alias-user-id', function (rudderElement) {
          console.log('alias call');
          document.getElementById('action').innerHTML = 'Alias called';
          document.getElementById('rudderElement').innerHTML = JSON.stringify(rudderElement);
        });
      }

      function group() {
        rudderanalytics.group(
          'sample_group_id',
          {
            name: 'Apple Inc.',
            location: 'USA',
          },
          function (rudderElement) {
            console.log('group call');
            document.getElementById('action').innerHTML = 'Group called';
            document.getElementById('rudderElement').innerHTML = JSON.stringify(rudderElement);
          }
        );
      }
    </script>
  </body>
</html>
