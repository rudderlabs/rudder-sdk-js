<!DOCTYPE html>
<html>
  <head>
    <script>
      // TODO: use detection to determine of should load legacy or modern package
      rudderanalytics = window.rudderanalytics = [];
      var methods = [
        'setDefaultInstanceKey',
        'getAnalyticsInstance',
        'load',
        'ready',
        'page',
        'track',
        'identify',
        'alias',
        'group',
        'reset',
        'getAnonymousId',
        'setAnonymousId',
        'getUserId',
        'getUserTraits',
        'getGroupId',
        'getGroupTraits',
        'startSession',
        'endSession',
        'getSessionId',
        'getSessionInfo'
      ];

      for (var i = 0; i < methods.length; i++) {
        var method = methods[i];
        rudderanalytics[method] = (function (methodName) {
          return function () {
            rudderanalytics.push([methodName].concat(Array.prototype.slice.call(arguments)));
          };
        })(method);
      }

      // New addition to load script starts
      var sdkBuildType = 'legacy';

      try {
        // Feature detection of dynamic imports
        new Function('return import("")');
        sdkBuildType = 'modern';
      } catch (e) {
      }

      var rudderCdnBaseUrlHost = 'https://cdn.rudderlabs.com/beta/v3/'
      var rudderAnalyticsBaseUrl = rudderCdnBaseUrlHost + sdkBuildType;
      var rudderAnalyticsMount = function() {
        var rudderAnalyticsScript = document.createElement('script');
        rudderAnalyticsScript.src = rudderAnalyticsBaseUrl + '/rudder-analytics.min.js';
        rudderAnalyticsScript.async = true;
        rudderAnalyticsScript.defer = true;
        // document.head.appendChild(rudderAnalyticsScript);
      };

      // Feature detection of promise
      if(typeof Promise === 'undefined') {
        var rudderAnalyticsPromisesScript = document.createElement('script');
        rudderAnalyticsPromisesScript.src = 'https://polyfill.io/v3/polyfill.min.js?features=Promise&callback=rudderAnalyticsMount';
        rudderAnalyticsPromisesScript.async = true;
        rudderAnalyticsPromisesScript.defer = true;
        document.head.appendChild(rudderAnalyticsPromisesScript);
      } else {
        rudderAnalyticsMount();
      }
      // New addition to load script ends

      rudderanalytics.load('__WRITE_KEY__', '__DATAPLANE_URL__', {
        logLevel: 'DEBUG',
        configUrl: '__CONFIG_SERVER_HOST__',
        destSDKBaseURL: '__DEST_SDK_BASE_URL__' + sdkBuildType + '/js-integrations',
        pluginsSDKBaseURL: '__PLUGINS_BASE_URL__' + sdkBuildType + '/plugins'
      });

      rudderanalytics.identify(
        'customUserID',
        {
          name: 'John Doe',
          title: 'CEO',
          email: 'name.surname@domain.com',
          company: 'Company123',
          phone: '123-456-7890',
          rating: 'Hot',
          city: 'Austin',
          postalCode: '12345',
          country: 'US',
          street: 'Sample Address',
          state: 'TX',
        },
        function() {
          console.log('in identify call');
        }
      );

      rudderanalytics.page(
        'Home',
        'Cart Viewed',
        {
          path: '',
          referrer: '',
          search: '',
          title: '',
          url: '',
        },
        function() {
          console.log('in page call');
        }
      );

      rudderanalytics.track(
        'test track event 1',
        {
          revenue: 30,
          currency: 'USD',
          user_actual_id: 12345,
        },
        function() {
          console.log('in track call 1');
        }
      );

      rudderanalytics.track(
        'test track event 2',
        {
          revenue: 45,
          currency: 'INR',
          user_actual_id: 333,
        },
        function() {
          console.log('in track call 2');
        }
      );

      rudderanalytics.track(
        'test track event 3',
        {
          revenue: 10003,
          currency: 'EUR',
          user_actual_id: 5678,
        },
        function() {
          console.log('in track call 3');
        }
      );

      rudderanalytics.ready(function() {
        console.log('All ready!!!');
      });

      // TODO: Call other APIs here
    </script>
  </head>
  <body>
    <h1>Page Loaded</h1>
  </body>
</html>
